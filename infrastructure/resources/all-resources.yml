MasterTable:
  Type: AWS::DynamoDB::Table
  Properties:
    TableName: ${self:custom.tableName}-master
    BillingMode: PAY_PER_REQUEST
    AttributeDefinitions:
      - AttributeName: mac_address
        AttributeType: S
      - AttributeName: plant_name
        AttributeType: S
      - AttributeName: equipment
        AttributeType: S
      - AttributeName: capture_date
        AttributeType: S
    KeySchema:
      - AttributeName: mac_address
        KeyType: HASH
    GlobalSecondaryIndexes:
      - IndexName: PlantDateIndex
        KeySchema:
          - AttributeName: plant_name
            KeyType: HASH
          - AttributeName: capture_date
            KeyType: RANGE
        Projection:
          ProjectionType: ALL
      - IndexName: EquipmentDateIndex
        KeySchema:
          - AttributeName: equipment
            KeyType: HASH
          - AttributeName: capture_date
            KeyType: RANGE
        Projection:
          ProjectionType: ALL
    StreamSpecification:
      StreamViewType: NEW_AND_OLD_IMAGES
    PointInTimeRecoverySpecification:
      PointInTimeRecoveryEnabled: true
    Tags:
      - Key: Environment
        Value: ${self:custom.stage}
      - Key: Service
        Value: ${self:service}

AITable:
  Type: AWS::DynamoDB::Table
  Properties:
    TableName: ${self:custom.tableName}-ai
    BillingMode: PAY_PER_REQUEST
    AttributeDefinitions:
      - AttributeName: camera_id
        AttributeType: S
    KeySchema:
      - AttributeName: camera_id
        KeyType: HASH
    StreamSpecification:
      StreamViewType: NEW_AND_OLD_IMAGES
    PointInTimeRecoverySpecification:
      PointInTimeRecoveryEnabled: true
    Tags:
      - Key: Environment
        Value: ${self:custom.stage}
      - Key: Service
        Value: ${self:service}

S3Bucket:
  Type: AWS::S3::Bucket
  Properties:
    BucketName: ${self:custom.bucketName}
    WebsiteConfiguration:
      IndexDocument: index.html
      ErrorDocument: index.html
    PublicAccessBlockConfiguration:
      BlockPublicAcls: false
      BlockPublicPolicy: false
      IgnorePublicAcls: false
      RestrictPublicBuckets: false
    CorsConfiguration:
      CorsRules:
        - AllowedOrigins:
            - "*"
          AllowedHeaders:
            - "*"
          AllowedMethods:
            - GET
            - HEAD
          MaxAge: 3000

ImagesS3Bucket:
  Type: AWS::S3::Bucket
  Properties:
    BucketName: ${self:custom.imagesBucket}
    PublicAccessBlockConfiguration:
      BlockPublicAcls: true
      BlockPublicPolicy: true
      IgnorePublicAcls: true
      RestrictPublicBuckets: true
    CorsConfiguration:
      CorsRules:
        - AllowedOrigins:
            - "*"
          AllowedHeaders:
            - "*"
          AllowedMethods:
            - GET
            - HEAD
            - PUT
            - POST
            - DELETE
          MaxAge: 3000

CognitoUserPool:
  Type: AWS::Cognito::UserPool
  Properties:
    UserPoolName: ${self:service}-user-pool-${self:custom.stage}
    AutoVerifiedAttributes:
      - email
    UsernameAttributes:
      - email
    UsernameConfiguration:
      CaseSensitive: false
    Policies:
      PasswordPolicy:
        MinimumLength: 8
        RequireUppercase: true
        RequireLowercase: true
        RequireNumbers: true
        RequireSymbols: false
        TemporaryPasswordValidityDays: 7
    MfaConfiguration: "OFF"
    AccountRecoverySetting:
      RecoveryMechanisms:
        - Name: verified_email
          Priority: 1
    UserPoolTags:
      Environment: ${self:custom.stage}
      Service: ${self:service}
    Schema:
      - Name: email
        AttributeDataType: String
        Required: true
        Mutable: true
      - Name: given_name
        AttributeDataType: String
        Required: false
        Mutable: true
      - Name: family_name
        AttributeDataType: String
        Required: false
        Mutable: true

CognitoUserPoolClient:
  Type: AWS::Cognito::UserPoolClient
  Properties:
    ClientName: ${self:service}-client-${self:custom.stage}
    UserPoolId: !Ref CognitoUserPool
    GenerateSecret: false
    ExplicitAuthFlows:
      - ALLOW_USER_PASSWORD_AUTH
      - ALLOW_USER_SRP_AUTH
      - ALLOW_REFRESH_TOKEN_AUTH
    SupportedIdentityProviders:
      - COGNITO
    CallbackURLs:
      - http://localhost:5001
      - https://${self:custom.bucketName}.s3-website-${self:provider.region}.amazonaws.com
    LogoutURLs:
      - http://localhost:5001
      - https://${self:custom.bucketName}.s3-website-${self:provider.region}.amazonaws.com
    AllowedOAuthFlows:
      - code
      - implicit
    AllowedOAuthScopes:
      - phone
      - email
      - openid
      - profile
    AllowedOAuthFlowsUserPoolClient: true
    RefreshTokenValidity: 30
    AccessTokenValidity: 1
    IdTokenValidity: 1
    TokenValidityUnits:
      AccessToken: hours
      IdToken: hours
      RefreshToken: days

CognitoIdentityPool:
  Type: AWS::Cognito::IdentityPool
  Properties:
    IdentityPoolName: ${self:service}_identity_pool_${self:custom.stage}
    AllowUnauthenticatedIdentities: false
    CognitoIdentityProviders:
      - ClientId: !Ref CognitoUserPoolClient
        ProviderName: !GetAtt CognitoUserPool.ProviderName

CognitoAuthRole:
  Type: AWS::IAM::Role
  Properties:
    RoleName: ${self:service}-auth-role-${self:custom.stage}
    AssumeRolePolicyDocument:
      Version: '2012-10-17'
      Statement:
        - Effect: Allow
          Principal:
            Federated: cognito-identity.amazonaws.com
          Action: sts:AssumeRoleWithWebIdentity
          Condition:
            StringEquals:
              'cognito-identity.amazonaws.com:aud': !Ref CognitoIdentityPool
            'ForAnyValue:StringLike':
              'cognito-identity.amazonaws.com:amr': authenticated
    Policies:
      - PolicyName: CognitoAuthPolicy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Action:
                - s3:GetObject
              Resource:
                - !Sub "arn:aws:s3:::${ImagesS3Bucket}/*"
            - Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:Query
              Resource:
                - !GetAtt MasterTable.Arn
                - !Sub "${MasterTable.Arn}/index/*"
                - !GetAtt AITable.Arn
                - !Sub "${AITable.Arn}/index/*"

IdentityPoolRoleMapping:
  Type: AWS::Cognito::IdentityPoolRoleAttachment
  Properties:
    IdentityPoolId: !Ref CognitoIdentityPool
    Roles:
      authenticated: !GetAtt CognitoAuthRole.Arn
